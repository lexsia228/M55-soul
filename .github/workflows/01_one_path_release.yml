name: M55 One-Path Release (Audit → Vercel Prod → Capacitor → fastlane)

on:
  workflow_dispatch:
    inputs:
      submit_ios:
        description: 'Submit iOS (TestFlight)'
        required: true
        default: 'true'
      submit_android:
        description: 'Submit Android (Play Internal)'
        required: true
        default: 'true'
  push:
    tags:
      - "m55-rc*"
      - "m55-prod*"

concurrency:
  group: m55-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 0) AUDIT GATE MUST ALWAYS RUN FIRST
  audit_gate:
    name: 00_audit_gate (Layer0/Layer1)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24.13.1
          cache: "npm"
      - run: npm ci
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: python -m pip install -r scripts/ci/guard/requirements.txt
      - name: Run Audit Gate
        run: npm run audit

  # 1) VERCEL PRODUCTION (Web Server / Middleware)
  vercel_prod:
    name: Deploy Vercel (production)
    runs-on: ubuntu-latest
    needs: audit_gate
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24.13.1
          cache: "npm"
      - run: npm ci
      - name: Install Vercel CLI
        run: npm i -g vercel
      - name: Pull Vercel settings
        run: vercel pull --yes --environment=production --token "$VERCEL_TOKEN"
      - name: Deploy to Production
        run: vercel deploy --prod --yes --token "$VERCEL_TOKEN"

  # 2) ANDROID (Bundled Legacy)
  android_internal:
    name: Android → fastlane (internal) [Bundled Legacy]
    runs-on: ubuntu-latest
    needs: vercel_prod
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.submit_android == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24.13.1
          cache: "npm"
      - run: npm ci
      
      - name: Verify Mobile Assets
        run: test -f public/legacy/index.html

      # Setup Java 17 for Android Build
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Prepare Capacitor Android
      - name: Prepare Capacitor (android)
        run: bash scripts/ci/ensure_cap_platforms.sh --android

      # Build AAB
      - name: Build Android App Bundle
        run: |
          cd android
          ./gradlew bundleRelease

      # Setup Ruby for Fastlane
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Upload to Play (Internal)
        env:
          PLAY_JSON_KEY_BASE64: ${{ secrets.PLAY_JSON_KEY_BASE64 }}
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
        run: |
          echo "$PLAY_JSON_KEY_BASE64" | base64 --decode > /tmp/play-key.json
          export PLAY_JSON_KEY=/tmp/play-key.json
          # Note: ensure Gemfile exists in root or fastlane dir if using bundle exec
          # For now, assuming fastlane is installed via Gemfile
          bundle install
          bundle exec fastlane android internal

  # 3) iOS (Bundled Legacy)
  ios_testflight:
    name: iOS → fastlane (TestFlight) [Bundled Legacy]
    runs-on: macos-latest
    needs: vercel_prod
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.submit_ios == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24.13.1
          cache: "npm"
      - run: npm ci
      
      - name: Verify Mobile Assets
        run: test -f public/legacy/index.html

      # Prepare Capacitor iOS
      - name: Prepare Capacitor (ios)
        run: bash scripts/ci/ensure_cap_platforms.sh --ios

      # Setup Ruby for Fastlane
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          
      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_JSON_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_JSON_BASE64 }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: bundle exec fastlane ios testflight